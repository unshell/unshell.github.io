<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="芬奇的博客">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/blog/image/favicon.svg">

    <title>
        
        Tomcat 服务 - 芬奇的博客 | Finch&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/main.css?v=1023">
    <!-- Icon CSS -->
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2103599_gii1mr7u70l.css" type="text/css">
</head>
<body>
    <div class="site-nav-toggle" id="site-nav-toggle">
        <button><i class="iconfont icon-menu1"></i></button>
    </div>

    <div class="index-about">
        <i> 我相信所有坚韧不拔的努力，迟早会得来好报酬 </i>
    </div>

    <div class="index-container">
        
        <div class="index-left">
            <div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/blog/image/avatar.jpeg" />
        </div>
        <div class="name">
            <i>芬奇</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-home-"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-tags"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang"></i>
                    <span>归档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a href="javascript:void(0)" id="search">
                    <i class="iconfont icon-sousuo-2"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
    <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#catalina-bat"><span class="toc-text">catalina.bat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#org-apache-catalina"><span class="toc-text">org.apache.catalina</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Server-中的-shutdown-属性"><span class="toc-text">Server 中的 shutdown 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引文"><span class="toc-text">引文</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"><i class="iconfont icon-chacha"></i></span>
            <input type="text" id="search-input" autocomplete="off" placeholder="Search" />
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container"></div>
    </div>
</div>
            <div class="index-about-mobile">
                <i> 我相信所有坚韧不拔的努力，迟早会得来好报酬 </i>
            </div>
        </div>
        
        <div class="index-middle">
            <!-- Main Content -->
            <div class="post-container">
    <div class="post-title">
        Tomcat 服务
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-04-23</span></span>
        
        <span class="attr">标签：/
            
            <a class="tag" href="/blog/tags/#Tomcat" title="Tomcat">Tomcat</a>
            <span>/</span>
            
            
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
        </span>
        </span>
    </div>
    <div class="post-content ">
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>运行环境：Windows 10 | Apache Tomcat 9.0.34 | 博客记录时间：2020-4-23 17:16:12</p>
<p>通常我们 打开 / 关闭 Tomcat 服务时都会执行bin目录下的 startup.bat / shutdown.bat 文件。</p>
<p>但是细心的小伙伴就会发现(╮(￣▽￣)╭)，<code>startup.bat</code> 和 <code>shutdown.bat</code> 文件中都有这么一句话。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rem ---------------------------------------------------------------------------</span><br><span class="line">rem Start / Stop script <span class="keyword">for</span> the CATALINA Server</span><br><span class="line">rem ---------------------------------------------------------------------------</span><br><span class="line">call <span class="string">"%EXECUTABLE%"</span> start / stop %CMD_LINE_ARGS%</span><br></pre></td></tr></table></figure>
<p>所以不论是 startup 还是 shutdown 都是执行了 <code>catalina.bat</code>，只是执行的指令不同。</p>
<h2 id="catalina-bat"><a href="#catalina-bat" class="headerlink" title="catalina.bat"></a>catalina.bat</h2><p>首选我们分析下 <code>catalina.bat</code> 脚本的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rem Guess CATALINA_HOME <span class="keyword">if</span> not defined</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CURRENT_DIR=%cd%"</span></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%CATALINA_HOME%"</span> == <span class="string">""</span> goto gotHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CATALINA_HOME=%CURRENT_DIR%"</span></span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\catalina.bat"</span> goto okHome</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CATALINA_HOME=%cd%"</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"%CURRENT_DIR%"</span></span><br></pre></td></tr></table></figure>
<p>检验 CATALINA_HOME 环境变量，如果不正确则重新设置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> CLASSPATH=</span><br><span class="line"></span><br><span class="line">rem Get standard environment variables</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\bin\setenv.bat"</span> goto checkSetenvHome</span><br><span class="line">call <span class="string">"%CATALINA_BASE%\bin\setenv.bat"</span></span><br><span class="line">goto setenvDone</span><br><span class="line">:checkSetenvHome</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\setenv.bat"</span> call <span class="string">"%CATALINA_HOME%\bin\setenv.bat"</span></span><br><span class="line">:setenvDone</span><br><span class="line"></span><br><span class="line">rem Get standard Java environment variables</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span> goto okSetclasspath</span><br><span class="line"><span class="built_in">echo</span> Cannot find <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span></span><br><span class="line"><span class="built_in">echo</span> This file is needed to run this program</span><br><span class="line">goto end</span><br><span class="line">:okSetclasspath</span><br><span class="line">call <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span> %1</span><br><span class="line"><span class="keyword">if</span> errorlevel 1 goto end</span><br></pre></td></tr></table></figure>
<p>设置环境变量：</p>
<ul>
<li>在 CATALINA_BASE 和 CATALINA_BASE 寻找<code>setenv.bat</code>文件并执行，找不到则不执行。</li>
<li>寻找<code>setclasspath.bat</code>(设置 Java 相关的环境变量)文件并执行，找不到则结束。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rem Add tomcat-juli.jar to classpath</span><br><span class="line">rem tomcat-juli.jar can be over-ridden per instance</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\bin\tomcat-juli.jar"</span> goto juliClasspathHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CLASSPATH=%CLASSPATH%;%CATALINA_BASE%\bin\tomcat-juli.jar"</span></span><br><span class="line">goto juliClasspathDone</span><br><span class="line">:juliClasspathHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CLASSPATH=%CLASSPATH%;%CATALINA_HOME%\bin\tomcat-juli.jar"</span></span><br><span class="line">:juliClasspathDone</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JSSE_OPTS%"</span> == <span class="string">""</span> goto gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JSSE_OPTS=-Djdk.tls.ephemeralDHKeySize=2048"</span></span><br><span class="line">:gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% %JSSE_OPTS%"</span></span><br><span class="line"></span><br><span class="line">rem Register custom URL handlers</span><br><span class="line">rem Do this here so custom URL handles (specifically <span class="string">'war:...'</span>) can be used <span class="keyword">in</span> the security policy</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% -Djava.protocol.handler.pkgs=org.apache.catalina.webresources"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%LOGGING_CONFIG%"</span> == <span class="string">""</span> goto noJuliConfig</span><br><span class="line"><span class="built_in">set</span> LOGGING_CONFIG=-Dnop</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\conf\logging.properties"</span> goto noJuliConfig</span><br><span class="line"><span class="built_in">set</span> LOGGING_CONFIG=-Djava.util.logging.config.file=<span class="string">"%CATALINA_BASE%\conf\logging.properties"</span></span><br><span class="line">:noJuliConfig</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%LOGGING_MANAGER%"</span> == <span class="string">""</span> goto noJuliManager</span><br><span class="line"><span class="built_in">set</span> LOGGING_MANAGER=-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</span><br><span class="line">:noJuliManager</span><br></pre></td></tr></table></figure>
<p>tomcat-juli.jar：</p>
<ul>
<li>将 <strong>tomcat-juli.jar</strong> 添加到 classPath 环境变量中。</li>
<li>将日志的配置文件路径添加到 LOGGING_CONFIG 环境变量中。</li>
</ul>
<blockquote>
<p>Apache Tomcat由一个自己的实现了 java.util.logging 多个关键元素的实现。这个实现被称为 JULI 。实现的核心组件是定制化的 LogManager ，可以获取运行在Tomcat中的不同web应用(以及不同的class loader)。他支持为应用配置单独的日志配置。当有web应用从内在中是被卸载时，会接到Tomcat的通知，以便他所引用的类可以被清除，避免内存泄露。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rem Execute The Requested Command</span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_BASE:   <span class="string">"%CATALINA_BASE%"</span></span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_HOME:   <span class="string">"%CATALINA_HOME%"</span></span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_TMPDIR: <span class="string">"%CATALINA_TMPDIR%"</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>debug<span class="string">""</span> goto use_jdk</span><br><span class="line"><span class="built_in">echo</span> Using JRE_HOME:        <span class="string">"%JRE_HOME%"</span></span><br><span class="line">goto java_dir_displayed</span><br><span class="line">:use_jdk</span><br><span class="line"><span class="built_in">echo</span> Using JAVA_HOME:       <span class="string">"%JAVA_HOME%"</span></span><br><span class="line">:java_dir_displayed</span><br><span class="line"><span class="built_in">echo</span> Using CLASSPATH:       <span class="string">"%CLASSPATH%"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> _EXECJAVA=%_RUNJAVA%</span><br><span class="line"><span class="built_in">set</span> MAINCLASS=org.apache.catalina.startup.Bootstrap</span><br><span class="line"><span class="built_in">set</span> ACTION=start</span><br><span class="line"><span class="built_in">set</span> SECURITY_POLICY_FILE=</span><br><span class="line"><span class="built_in">set</span> DEBUG_OPTS=</span><br><span class="line"><span class="built_in">set</span> JPDA=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>jpda<span class="string">""</span> goto noJpda</span><br><span class="line"><span class="built_in">set</span> JPDA=jpda</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_TRANSPORT%"</span> == <span class="string">""</span> goto gotJpdaTransport</span><br><span class="line"><span class="built_in">set</span> JPDA_TRANSPORT=dt_socket</span><br><span class="line">:gotJpdaTransport</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_ADDRESS%"</span> == <span class="string">""</span> goto gotJpdaAddress</span><br><span class="line"><span class="built_in">set</span> JPDA_ADDRESS=localhost:8000</span><br><span class="line">:gotJpdaAddress</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_SUSPEND%"</span> == <span class="string">""</span> goto gotJpdaSuspend</span><br><span class="line"><span class="built_in">set</span> JPDA_SUSPEND=n</span><br><span class="line">:gotJpdaSuspend</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_OPTS%"</span> == <span class="string">""</span> goto gotJpdaOpts</span><br><span class="line"><span class="built_in">set</span> JPDA_OPTS=-agentlib:jdwp=transport=%JPDA_TRANSPORT%,address=%JPDA_ADDRESS%,server=y,<span class="built_in">suspend</span>=%JPDA_SUSPEND%</span><br><span class="line">:gotJpdaOpts</span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line">:noJpda</span><br></pre></td></tr></table></figure>
<ul>
<li>设置启动类 - org.apache.catalina.startup.Bootstrap</li>
<li>设置远程调试相关参数 - JPDA</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>debug<span class="string">""</span> goto doDebug</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>run<span class="string">""</span> goto doRun</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>start<span class="string">""</span> goto doStart</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>stop<span class="string">""</span> goto doStop</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>configtest<span class="string">""</span> goto doConfigTest</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>version<span class="string">""</span> goto doVersion</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Usage:  catalina ( commands ... )</span><br><span class="line"><span class="built_in">echo</span> commands:</span><br><span class="line"><span class="built_in">echo</span>   debug             Start Catalina <span class="keyword">in</span> a debugger</span><br><span class="line"><span class="built_in">echo</span>   debug -security   Debug Catalina with a security manager</span><br><span class="line"><span class="built_in">echo</span>   jpda start        Start Catalina under JPDA debugger</span><br><span class="line"><span class="built_in">echo</span>   run               Start Catalina <span class="keyword">in</span> the current window</span><br><span class="line"><span class="built_in">echo</span>   run -security     Start <span class="keyword">in</span> the current window with security manager</span><br><span class="line"><span class="built_in">echo</span>   start             Start Catalina <span class="keyword">in</span> a separate window</span><br><span class="line"><span class="built_in">echo</span>   start -security   Start <span class="keyword">in</span> a separate window with security manager</span><br><span class="line"><span class="built_in">echo</span>   stop              Stop Catalina</span><br><span class="line"><span class="built_in">echo</span>   configtest        Run a basic syntax check on server.xml</span><br><span class="line"><span class="built_in">echo</span>   version           What version of tomcat are you running?</span><br><span class="line">goto end</span><br></pre></td></tr></table></figure>
<p>这里值得注意的且常用的(start / stop)，正如开头提到的。</p>
<h2 id="org-apache-catalina"><a href="#org-apache-catalina" class="headerlink" title="org.apache.catalina"></a>org.apache.catalina</h2><p>解压 bin 目录中的 catalina.jar 后我们能找到 org.apache.catalina.startup.Bootstrap 也就是 catalina.bat 里设置的启动类(MAINCLASS)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">        String command = <span class="string">"start"</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            command = args[args.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">            daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当指令等于<code>start</code>时运行 Catalina.class 中的 <code>start()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Catalina</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.await) &#123;</span><br><span class="line">            <span class="keyword">this</span>.await();</span><br><span class="line">            <span class="keyword">this</span>.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>start()</code>方法中调用了<code>await()</code>和<code>stop()</code>两个方法：</p>
<ul>
<li><p><code>await()</code> 方法监听停止服务请求的方法</p>
</li>
<li><p><code>stop()</code> 方法是停止服务的方法</p>
</li>
</ul>
<blockquote>
<p><code>await()</code> 方法是阻塞方法，只有客户端请求关闭Tomcat服务时，他才会执行<code>stop()</code>方法，否则一直等待关闭请求。</p>
</blockquote>
<p>StandardServer.class 中的 <code>await()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardServer</span> <span class="keyword">extends</span> <span class="title">LifecycleMBeanBase</span> <span class="keyword">implements</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServerSocket awaitSocket = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String shutdown = <span class="string">"SHUTDOWN"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.awaitSocket = <span class="keyword">new</span> ServerSocket(<span class="keyword">this</span>.getPortWithOffset(), <span class="number">1</span>,InetAddress.getByName(<span class="keyword">this</span>.address));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var67) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"standardServer.awaitSocket.fail"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>.address,String.valueOf(<span class="keyword">this</span>.getPortWithOffset()), String.valueOf(<span class="keyword">this</span>.getPort()),String.valueOf(<span class="keyword">this</span>.getPortOffset())&#125;), var67);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ServerSocket serverSocket;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/* 略 */</span></span><br><span class="line">             <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                 label611: &#123;</span><br><span class="line">                     label610: &#123;</span><br><span class="line">                         <span class="keyword">try</span> &#123;</span><br><span class="line">                             label634: &#123;</span><br><span class="line">                                 <span class="keyword">try</span> &#123;</span><br><span class="line">                                     <span class="comment">// 执行accept等待请求</span></span><br><span class="line">                                     socket = serverSocket.accept();</span><br><span class="line">                                     socket.setSoTimeout(<span class="number">10000</span>);</span><br><span class="line">                                     stream = socket.getInputStream();</span><br><span class="line">                                 &#125; <span class="keyword">catch</span> (SocketTimeoutException var69) &#123;</span><br><span class="line">                                     log.warn(sm.getString(<span class="string">"standardServer.accept.timeout"</span>, <span class="keyword">new</span> Object[]&#123;System.currentTimeMillis() - acceptStartTime&#125;), var69);</span><br><span class="line">                                     <span class="keyword">continue</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                                 <span class="comment">/* 略 */</span></span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">/* 略 */</span></span><br><span class="line">                 <span class="keyword">boolean</span> match = command.toString().equals(<span class="keyword">this</span>.shutdown);</span><br><span class="line">                 <span class="comment">// 如果请求内容与 shutdown 字段相同则跳出循环，Socket 服务停止</span></span><br><span class="line">                 <span class="keyword">if</span> (match) &#123;</span><br><span class="line">                     log.info(sm.getString(<span class="string">"standardServer.shutdownViaPort"</span>));</span><br><span class="line">                     var32 = <span class="keyword">false</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 log.warn(sm.getString(<span class="string">"standardServer.invalidShutdownCommand"</span>, <span class="keyword">new</span> Object[]&#123;command.toString()&#125;));</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里开启了一个 ServerSocket ，调用 accept() 方法监听请求。</p>
<p><code>serverSocket.close()</code>之后 <code>start()</code>方法中的<code>this.stop()</code>执行，Server 被关闭。</p>
<p>当指令等于<code>stop</code>时运行 Catalina.class 中的 <code>stopServer()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">(String[] arguments)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (arguments != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.arguments(arguments);</span><br><span class="line">    &#125;</span><br><span class="line">    Server s = <span class="keyword">this</span>.getServer();</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            s.stop();</span><br><span class="line">            s.destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException var63) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"catalina.stopError"</span>), var63);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显而易见，Server 不为 null 时，停止并且销毁。</p>
<h2 id="Server-中的-shutdown-属性"><a href="#Server-中的-shutdown-属性" class="headerlink" title="Server 中的 shutdown 属性"></a>Server 中的 shutdown 属性</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8085"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</span><br></pre></td></tr></table></figure>
<p>这里<code>shutdown</code>的默认属性就是<code>SHUTDOWN</code>，与 StandardServer 类中 shutdown 属性的值一样。</p>
<blockquote>
<p>当然 StandardServer 类中 shutdown 属性提供了 setShutdown(String shutdown) 方法。</p>
</blockquote>
<p>做个测试，我们执行 startup.bat 先启动 Tomcat ，跳出窗口并打印日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Tomcat</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat/9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│<span class="comment"># 略</span></span><br><span class="line">│Server startup <span class="keyword">in</span> [673] milliseconds</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>我们再启动另一个窗口，进入<code>telnet</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Microsoft Windows [版本 10.0.17763.1039]</span><br><span class="line">│(c) 2018 Microsoft Corporation。保留所有权利。</span><br><span class="line">│C:\Users\Administrator&gt;telnet localhost 8005</span><br><span class="line">│正在连接localhost...</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>之后我们再像8005端口发送点东西</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Telnet localhost</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│unshell</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>发送<code>unshell</code>字符串，Tomcat窗口打印出新的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Tomcat</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat/9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│# 略</span><br><span class="line">│Server startup in [673] milliseconds</span><br><span class="line">│Invalid shutdown command [unshell] received</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>如果内容没有更新可以尝试按<code>enter</code>键</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 完整内容如下(可以看到警告的方法，就如我们之前所说的那样)</span><br><span class="line"><span class="number">23</span>-Apr-<span class="number">2020</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">20</span><span class="variable">.166</span> 警告 [main] org<span class="variable">.apache</span><span class="variable">.catalina</span><span class="variable">.core</span><span class="variable">.StandardServer</span><span class="variable">.await</span> Invalid shutdown command [unshell] received</span><br></pre></td></tr></table></figure>
<p>所以当我们输入指令为<code>SHUTDOWN</code>时，Tomcat 就关闭了。</p>
<p>当然这个指令默认监听<code>localhost</code>的关闭请求，如果要支持远程关闭的话，可以添加参数 address，例子如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8085"</span> shutdown=<span class="string">"SHUTDOWN"</span> address=<span class="string">"36.152.44.95"</span>&gt;</span><br></pre></td></tr></table></figure>
<p>具体版本是否支持该参数，运行 Tomcat ，文档在 <code>http://localhost:8080/docs/config/server.html</code>中有说明。</p>
<p>这里以版本9为例</p>
<p>All implementations of <strong>Server</strong> support the following attributes：</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>port</td>
<td>The TCP/IP port number on which this server waits for a shutdown command. Set to <code>-1</code> to disable the shutdown port.</td>
</tr>
<tr>
<td>shutdown</td>
<td>The command string that must be received via a TCP/IP connection to the specified port number, in order to shut down Tomcat.</td>
</tr>
<tr>
<td>address</td>
<td>The TCP/IP address on which this server waits for a shutdown command. If no address is specified, <code>localhost</code> is used.</td>
</tr>
</tbody>
</table>
<blockquote>
<p>以上就是所有内容，本文只是在理解 Tomcat 时，碰巧看到的一些边缘内容，作为记录保存下来。</p>
</blockquote>
<h2 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h2><ul>
<li><p><a href="https://www.jianshu.com/p/b2f63ffa964c" target="_blank" rel="noopener">Tomcat catalina.bat 原理解析</a></p>
</li>
<li><p><a href="https://cloud.tencent.com/developer/article/1129737" target="_blank" rel="noopener">Tomcat 怎么停止服务的?</a></p>
</li>
</ul>

    </div>
</div>
        </div>
    </div>

    <footer class="footer">
    <ul class="list-inline text-center">
        
        <li>
            <a target="_blank" href="https://github.com/unshell">
                <span class="fa-stack fa-lg">
                    <i class="iconfont icon-github"></i>
                </span>
            </a>
        </li>
        
    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://hexo.io/zh-cn/">Hexo</a></span>
        <span>/</span>
        
        <span><a href="http://niexiaotao.cn/">AirCloud</a></span>
        <span>/</span>
        
        <span><a href="https://www.iconfont.cn/">Alibaba Icon</a></span>
        <span>/</span>
        
    </p>
    
    <p>@ 2018 - 2020 UnShell</p>
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
    </p>
</footer>
</body>
<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json";
    window.hexo_root = "/blog/";
    window.isPost = true;
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js?v=1023"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</html>